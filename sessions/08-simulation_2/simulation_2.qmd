---
title: "State transition and discrete event simulation"
subtitle: "EPIB  676 session 8, McGill University"
author: "Alton Russell"
date: "29 Jan 2026"
format: revealjs
editor: visual
---

## R packages

```{r}
#| echo: true
library(ggplot2)
library(Rcpp)
```

## Today

-   [**Individual discrete time state transition simulation**]{.underline}
-   Time to event modelling
-   Discrete event simulation without capacity constraints
-   Discrete event simulation with capacity constraints

## Why simulate a state transition model?

Enables flexibility without state state explosion

Transitions, costs, health outcomes can depend on complex functions of

-   Simulation time

-   Time in health state

-   Prior health states

-   Baseline characteristics

## Tracking individuals

For each variable, use $n_i \times n_t$ matrices, or $n_i \times (n_t+1)$, where:

-   $n_i$ is the number of individuals

-   $n_t$ is the number of cycles.

**Setup** (building on our CSTM notation)**:**

-   $M_m[i,t]$ gives state of individual $i$ in cycle $t$

-   $M_c[i,t]$ gives costs accrued by individual $i$ in cycle $t$

-   $M_q[i,t]$ gives QALYs experienced by indiv. $i$ in cycle $t$

-   Can make matrices for anything you wish to track over time

## Sick-sicker sim, Krijkamp et. al. 2018

![](figs/sim_CSTM_parameters.png)

## Sick-sicker sim, Krijkamp et. al. 2018

![](figs/sim_CSTM_algorithm.png)

## Sick-sicker sim, Krijkamp et. al. 2018

Open up `sicksicker_microsim_B.R`. We will walk through it together

## Recall: how to decide how many individuals to sample?

-   Simulate enough patients that monte carlo simulaiton error is negligible

-   Can assess via

    -   Monte Carlo standard error

    -   Running multiple simulations with different seeds & comparing outcomes

    -   Bootstrap resampling of simulated individuals

See: "Convergence" section of session 7 slides

## "Convergence" plots

![](figs/sim_CSTM_sim_error.png)

## Today

-   Individual discrete time state transition simulation
-   [**Time to event modelling**]{.underline}
-   Discrete event simulation without capacity constraints
-   Discrete event simulation with capacity constraints

## Intensity (hazard) functions

-   Events (transitions) can be modeled with intensity functions
-   Intensity function $\lambda_{ij}(t)$ gives instantaneous risk of transition from state $i$ to $j$ at time $t$
-   Often easier to work with the cumulative intensity function:
    -   $\Lambda_{ij}(t) = \int_0^t \lambda_{ij}(u) du$
    -   Probability of transitioning from $i$ to $j$ between time 0 and $t$

## Homogeneous Poisson process

-   Constant intensity function: $\lambda_{ij}(t) = \lambda_{ij}$
-   Time to event is exponentially distributed

$$f_{ij}(t) = \lambda_{ij} e^{-\lambda_{ij} t}$$

```{r}
#| echo: true

# Example: simulate time to event from exponential distribution
set.seed(123)
n = 10
lambda = 0.2 # constant hazard
time_to_event = rexp(n, rate = lambda)
time_to_event

```

## Non-homogeneous Poisson process

-   Time-varying intensity function: $\lambda_{ij}(t)$
-   Parametric time-to-event distributions
    -   Weibull, Gompertz distributions
    -   Cumulative intensity function used to derive time to event
-   Nonparametric time-to-event distributions
    -   Life tables

## Sampling time-to-event with inversion method

1.  Sample $u$ from Uniform(0,1)

2.  Set cumulative distribution function equal to $u$:

    $$F_{ij}(t) = 1 - e^{-\Lambda_{ij}(t)} = u$$

3.  Solve for $t$ to get time to event: $$t = F_{ij}^{-1}(u)$$

## Inversion method examples

Exponential CDF:

$$F_{ij}(t) = 1 - e^{-\lambda_{ij} t}$$

Exponential inverted CDF:

$$t = -\frac{\log(1-u)}{\lambda_{ij}}$$
Weibull CDF (a is scale parameter, b is shape parameter):
$$F_{ij}(t) = 1 - e^{-(t/a)^{b}}$$

Weibull inverted CDF:
$$ t = -a \log(1-u)^{1/b} $$

## Inversion method in R

```{r}
#| echo: true
#| message: false
n = 100; u = runif(n)
#Exponential intensity function
lambda = 0.2
time_to_event_Exponential = - log(1 - u) / (1/lambda)
summary(time_to_event_Exponential)
#Weibull
shape = 1.5; scale = 2
time_to_event_Weibull = -1*scale * log(1 - u)^(1/shape)
summary(time_to_event_Weibull)
```

## Simulate competing events

If \>1 event can happen from the individual's current state:

-   Simulate time-to-event (or "dwell time") for each

-   Pick the shortest one and update the clock

This is known as [**next-event-advance-clock**]{.underline}

## Today

-   Individual discrete time state transition simulation
-   Time to event modelling
-   [**Discrete event simulation without capacity constraints**]{.underline}
-   Discrete event simulation with capacity constraints

## Today

-   Individual discrete time state transition simulation
-   Time to event modelling
-   Discrete event simulation without capacity constraints
-   [**Discrete event simulation with capacity constraints**]{.underline}

## Credit

Much of this section is based on:

[*Discrete Event Simulation for Health Technology Assessment (2016) by Caro et. al.*](https://www.routledge.com/Discrete-Event-Simulation-for-Health-Technology-Assessment/Caro-Moller-Karnon-Stahl-Ishak/p/book/9780367737689)

## Discrete event simulation strengths

-   Model heterogeneous population\*

-   Time-varying parameters\*

\*same as microsim

-   Represent disease as continuous process

-   Model [**capacity-constrained**]{.underline} resources

-   Entity types interact (patient, provider, tumor, etc.)^+^

^+^In a limited way

## Key components

-   **Events:** instantaneous change to entity or system

-   **Entities:** person or thing that experiences events

    -   patients, providers, ambulance, etc.

-   **Attributes:** information specific to entity

    -   Age, health state, 'in service'

-   **Resources:** provide service and have fixed capacity

    -   Providers, exam room, operating room, ventillator, etc.

-   **Queues:** lists of entities waiting for resource

## DES in health vs. elsewhere

-   DES common for manufacturing, logistics, traffic engineering

-   Focus usually on **system-level outcomes**

    -   Production volume, wastage, resource utilization, processing time

-   Health applications focus more on **entities'** state and pathway (patients)

    -   Often track more entity-level attributes

## Examples of events

![](figs/des_event_examples.png)

## Event graph

![](figs/DES-event-graph.png)

Arrows show sequence of events.

## Discrete events but continuous time

-   Events are instantaneous

-   Time between events usually sampled from distribution

-   State of system updated each time an event occurs

-   Unlike discrete time models with a constant cycle length, the "step size" varies depending on the time between events

    -   "Next-event-time-advance"

## Attributes

-   Some assigned at baseline and not changed (e.g., sex), others updated by events (e.g., cumulative costs, blood pressure)

-   Probability & timing of events can depend on attributes

![](figs/entity-attribute-example.png)

## Examples of attributes

![](figs/attribute-examples.png)

## Example of next-event-time-advance

![](figs/des_advance_1.png)

## Example of next-event-time-advance

![](figs/des_advance_2.png)

## Example of next-event-time-advance

![](figs/des_advance_3.png)

## Example of next-event-time-advance

![](figs/des_advance_4.png)

## Example of next-event-time-advance

![](figs/des_advance_5.png)

## Example of next-event-time-advance

![](figs/des_advance_6.png)

## Example: time to competing events

```{r}
#| echo: true

# Events can have different distributions
time_to_checkup = rep(1, 15) # Always 1 year apart
time_to_polyp = rexp(n=15, rate = 1.5) # Sampled from distribution
# The clock goes until the next one occurs
time = pmin(time_to_checkup, time_to_polyp)
event=ifelse(time_to_checkup<time_to_polyp, "checkup","polyp developed")
cat(paste0("i: ", 1:15, "   event: ", event, "   time: ", time, "\n"))
```

## Global variables

-   Track the state of the [**system**]{.underline}

-   Memory-efficient (vs. individual attributes)

-   Some applications track only global variables

![](figs/attribute-vs-global-variable.png)

## Global variable examples

![](figs/global_variable_examples.png)

## Time

-   Pre-specify total simulation time, run until reach

-   Entities enter (are created) and exit at various times

-   Capacity constrained resources are "seized" and "released" by entities

    -   Entities must queue if all resources are seized
    -   This is the interaction between entities!

## Resource capacity and availability

![](figs/capacity_illustration.png)

## Resources for DES

-   [Simmer R package](https://r-simmer.org/) \[[2021 workshop Koen Degeling](https://r-hta.org/events/workshop/2021/degeling.pdf)\], \[[2019 presentation Biller et. al](http://www.trutschnig.net/Slides_simmer_Biller_Koehnke_Mayr.pdf).\]

-   [Microsimulation package](https://cran.r-project.org/web/packages/microsimulation/index.html) \[[2021 workshop Mark Clements](https://r-hta.org/events/workshop/2021/clements.pdf)\]

-   [r-hta.org tutorial using descem, Alvarez and Ribero](https://r-hta.org/tutorial/descem/)

Dedicated software: Arena, Simul8

## Logistics

-   Assignment 2 due 11:59 tomorrow
-   Assignment 3 available, due Fri, Oct 4
-   Assignments 0 & 1 graded, solution posted to mycourses
